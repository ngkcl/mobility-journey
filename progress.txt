## Codebase Patterns
- When adding new Expo Router routes, update `.expo/types/router.d.ts` so `router.push` stays type-safe.
- Keep Expo/React Native runtime-only modules (e.g. notifications) isolated from testable logic to avoid Node test loader issues.
- For streak calculations that check "active" status, use relative dates (today/yesterday) in tests.
- CSV export: escape commas/quotes properly, use native share sheet on mobile.
- For date logic that uses local time (`getHours`, `getDate`), write tests with local timestamps (no `Z`) to avoid timezone-dependent failures.

---
## 2025-02-10 - Overnight Feature Sprint: Streak Tracking + Data Export

### Completed
1. **Workout Streak Tracking with Calendar Heat Map**
   - Added `computeStreakStats()` to calculate current streak, best streak, and total workout days
   - Added `buildCalendarHeatMap()` for visual activity tracking (last 2 months)
   - Added `getStreakMessage()` for motivational messages based on streak status
   - Created `StreakCard` component with:
     - Current/Best/Total workout day statistics
     - Month-by-month calendar heat map (green = workout, gray = missed)
     - Motivational emoji + messages (üî• On Fire, üèÜ Legendary, etc.)
     - CTA button to start workout when streak is broken
   - Integrated StreakCard into Charts screen
   - Updated consistency chart to show best streak instead of current

2. **Export Workout Data**
   - Created `lib/exportData.ts` with:
     - `buildWorkoutCSV()` - generates CSV with all workout details
     - `computeWorkoutSummary()` - calculates totals and statistics
     - `buildWorkoutExportPayload()` - structured JSON export
   - Added export UI in workouts.tsx:
     - Export button in workout history header
     - CSV/JSON format toggle selector
     - Native share sheet on mobile, download on web
   - CSV includes: dates, exercises, sets, reps, weight, pain levels, volume, asymmetry

### Files Changed
- lib/workoutAnalytics.ts (streak stats, heat map, messages)
- lib/workoutAnalytics.test.js (relative date tests)
- lib/exportData.ts (new - CSV/JSON export)
- lib/exportData.test.js (new - export tests)
- components/StreakCard.tsx (new - streak visualization)
- app/(tabs)/charts.tsx (integrated StreakCard)
- app/(tabs)/workouts.tsx (export functionality)

### Learnings
- Streak "active" status should check if most recent workout is today or yesterday
- Test streak calculations with relative dates, not hardcoded future dates

---
## 2026-02-07 13:07 - Story WK-001: Exercise library with scoliosis-specific exercises

### Completed
- Added `exercises` Supabase table migration with seeded corrective + gym exercises.
- Built Exercise Library tab with search, category/target filters, and custom exercise creation.
- Added exercise detail screen showing targets, defaults, and side-specific emphasis.
- Added normalization utility + tests and updated route type definitions.

### Next Up (for next iteration)
- [ ] Start WK-002: workout logging tables + UI flow for workouts and sets.
- [ ] Confirm Supabase schema updates for workouts and workout_exercises.

### Blockers/Warnings
- `git push origin ralph/workout-tracker` failed: no `origin` remote configured.

### Files Changed
- supabase/migrations/20260207_exercises.sql
- lib/types.ts
- lib/exercises.ts
- lib/exercises.test.js
- app/(tabs)/exercises.tsx
- app/exercise/[id].tsx
- app/(tabs)/_layout.tsx
- .expo/types/router.d.ts
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- Added route typing update for new screens to keep `router.push` typecheck happy.
---
---
## 2026-02-07 13:14 - Story WK-002: Workout logging with sets, reps, weight

### Completed
- Added workouts/workout_exercises Supabase migration and new workout types.
- Built Workouts tab with start flow, exercise picker, per-set logging (side-specific), rest timer, and completion summary.
- Added workout summary utilities and tests for volume/left-right splits.

### Next Up (for next iteration)
- [ ] Start WK-003: corrective protocol templates and guided workout flow.
- [ ] Decide if workout history should include detail drill-down view.

### Blockers/Warnings
- `git push origin ralph/workout-tracker` failed: no `origin` remote configured.

### Files Changed
- supabase/migrations/20260207_workouts.sql
- lib/types.ts
- lib/workouts.ts
- lib/workouts.test.js
- app/(tabs)/workouts.tsx
- app/(tabs)/_layout.tsx
- .expo/types/router.d.ts
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- None.
---
---
## 2026-02-07 13:23 - Story WK-003: Corrective protocol templates (morning/midday/evening)

### Completed
- Added workout_templates Supabase migration with seeded morning/midday/evening corrective templates.
- Added guided protocol flow with timers, set tracking, and auto-advance, plus template customization UI.
- Added template helpers + tests for template set defaults.

### Next Up (for next iteration)
- [ ] Start WK-004: AI daily plan generator screen + API integration.
- [ ] Decide on workout history drill-down design for WK-005.

### Blockers/Warnings
- `git push origin ralph/workout-tracker` failed: no `origin` remote configured.

### Files Changed
- supabase/migrations/20260207_workout_templates.sql
- lib/types.ts
- lib/templates.ts
- lib/templates.test.js
- app/(tabs)/workouts.tsx
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- None.
---
---
## 2026-02-07 13:31 - Story WK-004: AI daily plan generator

### Completed
- Added daily plan Supabase table for generated plans with status tracking.
- Built Daily Plan tab with AI generation flow, plan editing, accept/regenerate actions, and plan history.
- Added daily plan normalization helpers and tests plus API client call.

### Next Up (for next iteration)
- [ ] Start WK-005: workout history list + analytics views.
- [ ] Confirm the daily plan API endpoint format matches the server implementation.

### Blockers/Warnings
- `git push origin ralph/workout-tracker` failed: no `origin` remote configured.

### Files Changed
- supabase/migrations/20260207_daily_plans.sql
- lib/api.ts
- lib/dailyPlan.ts
- lib/dailyPlan.test.js
- lib/types.ts
- app/(tabs)/plan.tsx
- app/(tabs)/_layout.tsx
- .expo/types/router.d.ts
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- None.
---
---
## 2026-02-07 13:38 - Story WK-005: Workout history and progress analytics

### Completed
- Extended workouts screen with history filters (date range, type, search) and expandable detail cards.
- Added workout analytics utilities and tests for consistency, streaks, volume, and side balance.
- Integrated workout analytics into Progress Charts with volume trends, strength progression, and left/right comparisons.

### Next Up (for next iteration)
- [ ] Start WK-006: workout reminders and scheduling.
- [ ] Confirm notification permissions flow for expo-notifications on iOS/Android.

### Blockers/Warnings
- None.

### Files Changed
- app/(tabs)/workouts.tsx
- app/(tabs)/charts.tsx
- lib/workoutAnalytics.ts
- lib/workoutAnalytics.test.js
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- None.
---
---
## 2026-02-07 14:09 - Story WK-006: Workout reminders and scheduling

### Completed
- Added workout schedule screen with session times, day toggles, and calendar preview.
- Implemented AsyncStorage-backed schedule normalization utilities and tests.
- Wired expo-notifications scheduling for corrective reminders/check-ins and added schedule access from Workouts.

### Next Up (for next iteration)
- [ ] Verify notification permissions + reminders on device (iOS/Android) and adjust channel config if needed.
- [ ] Decide if gym day reminders need a configurable time.

### Blockers/Warnings
- `git push origin ralph/workout-tracker` failed previously: no `origin` remote configured.

### Files Changed
- app/_layout.tsx
- app/(tabs)/workouts.tsx
- app/workout-schedule.tsx
- lib/workoutSchedule.ts
- lib/workoutSchedule.test.js
- lib/workoutNotifications.ts
- package.json
- pnpm-lock.yaml
- .expo/types/router.d.ts
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- None.
---

---
## 2025-02-09 - UX & Analytics Improvements

### Completed
1. **Fixed desktop TypeScript errors**
   - Added proper type declarations for @mediapipe/pose and @mediapipe/camera_utils
   - Added electron type reference for module resolution
   - Fixed posture-monitor.ts timer type (NodeJS.Timeout ‚Üí ReturnType<typeof setInterval>)
   - Updated tsconfig.json with custom typeRoots

2. **Enhanced workout analytics** (lib/workoutAnalytics.ts)
   - `buildOverallAsymmetryTrend`: Track L/R volume imbalance across ALL exercises
   - `computeAsymmetrySummary`: Trend direction (improving/worsening/stable), dominant side
   - `buildWorkoutPainTrend`: Pain/energy levels before and after workouts
   - `computePainImpact`: Average pain change after workouts

3. **Added EmptyState component** (components/EmptyState.tsx)
   - Reusable empty state with icon, title, description, and action button
   - Consistent styling with design system

4. **Charts page enhancement** (app/(tabs)/charts.tsx)
   - Added "Balance Status" card showing current asymmetry %, dominant side, trend direction
   - Added "Pain Impact" card showing average pain change from workouts
   - Color-coded indicators for improvement/concern status

### Next Up
- [ ] Add EmptyState to more screens (exercises, workouts, metrics)
- [ ] Improve loading skeletons for better perceived performance
- [ ] Consider adding accessibility labels for screen readers
- [ ] Implement AirPods integration (needs dev build)

### Files Changed
- desktop/src/types/mediapipe.d.ts (new)
- desktop/src/types/electron.d.ts (new)
- desktop/tsconfig.json
- desktop/src/renderer/lib/posture-monitor.ts
- lib/workoutAnalytics.ts
- components/EmptyState.tsx (new)
- app/(tabs)/charts.tsx
- progress.txt

### Learnings
- Browser setInterval returns number, not NodeJS.Timeout. Use ReturnType<typeof setInterval> for cross-platform compatibility.
- For packages without @types, create src/types/package.d.ts and add typeRoots to tsconfig.

---
## 2026-02-08 - Desktop Posture App: Stats & Calibration Fixes

### Problem Diagnosed
Nick reported that after calibrating the posture monitor, stats stay at 0 and nothing happens.

**Root cause analysis:**
1. The app structure has TWO architectures:
   - Root-level JS files (main.js, preload.js, renderer.js) - ACTIVE, using MediaPipe via CDN
   - TypeScript in src/ - partially complete, src/main/ is EMPTY
   
2. Camera permission issues on macOS - the app wasn't properly requesting camera access.

3. Race condition in calibration - the calibration handler could be called multiple times if detectLoop continued running during calibration.

4. On systems without a camera (like Mac Mini), the app fails silently.

### Fixes Applied
1. **Camera permission handling** (main.js)
   - Added systemPreferences.askForMediaAccess('camera') on app ready
   - Shows notification if permission denied with instructions

2. **Better error messages** (renderer.js)
   - Camera errors now show specific messages (NotAllowedError, NotFoundError)
   - Added logging throughout for debugging

3. **Calibration race condition fix** (renderer.js)
   - Added `calibrationProcessed` flag to prevent double-processing
   - Skip detectLoop frames during calibration (isCalibrating check)
   - Restore normal handler BEFORE processing to prevent race

4. **Console logging from renderer** (main.js)
   - Added webContents.on('console-message') to forward renderer logs to main

5. **Stats API in preload** (preload.js)
   - Added getStats() and resetStats() to electronAPI for UI stats fetching

### Testing Notes
- Mac Mini has no camera, so app fails with "NotFoundError Requested device not found"
- On a device with camera (like Nick's laptop), the flow should work:
  1. App requests camera permission
  2. Camera initializes, MediaPipe loads
  3. Calibrate captures baseline
  4. detectLoop sends frames every 1.5s
  5. Stats accumulate in ~/.posture-data/stats.json

### Files Changed
- desktop/main.js (camera permission, logging)
- desktop/renderer.js (calibration fix, logging, error handling)
- desktop/preload.js (stats API)

### Next Steps
- [ ] Test on Nick's laptop with camera to verify full flow
- [ ] Consider adding a "mock camera" mode for development on devices without camera
- [ ] Add visual feedback when calibration countdown is happening

## Feb 9, 2026 ‚Äî Evening Session (Jared)

### Weekly Reports Feature Committed! üéâ

Found and committed ~2400 lines of uncommitted work on weekly reports system:

**What was shipped:**
- `lib/weeklyReport.ts` ‚Äî Core report generation with workout summaries, metric aggregation, photo tracking
- `lib/reportInsights.ts` ‚Äî Smart insight engine (achievements, warnings, tips) that generates actionable feedback
- `lib/weeklyReportStorage.ts` ‚Äî Supabase persistence layer with auto-generation logic
- `app/(tabs)/reports.tsx` ‚Äî Full 734-line Reports tab with beautiful card UI
- Tests for both report generation and insights (19 tests, all passing)
- Supabase migration for `weekly_reports` table

**Navigation change:**
- Reports tab now in main nav (replaced Charts)
- Charts still accessible via router.push() ‚Äî moved to hidden tabs

**Key features:**
- Insight engine surfaces max 5 most important observations per week
- Trends comparison (current week vs previous)
- Photo side-by-side comparison when available
- Share button with formatted text export
- Auto-generates last week's report on Monday app open

All 6 weekly report user stories (WR-001 through WR-006) now complete.
---
## [2026-02-09 05:14] - Story GL-001: Goal data model and storage

### Completed
- Added `lib/goals.ts` with goal domain types (`Goal`, `GoalType`, `GoalStatus`, `GoalProgress`) and progress-summary typing.
- Implemented goals data access helpers: `createGoal`, `updateGoal`, `deleteGoal`, `getGoals`, `getGoalProgress`.
- Implemented `computeGoalProgress(goal)` with direction-aware progress logic (pain goals decrease, score/consistency/streak goals increase), on-track calculation, projected completion, and trend detection.
- Added `lib/goals.test.js` with coverage for improvement goals, pain reduction, completion, regression, overdue goals, and projection behavior.
- Added Supabase migration `20260209_goals.sql` creating `goals` and `goal_progress` tables with constraints and indexes.
- Fixed pre-existing baseline test instability in `lib/homeSummary.test.js` (timezone-sensitive assertions and rotation expectation) so test suite is reliable.

### Next Up (for next iteration)
- [ ] Start GL-002: implement the goal creation wizard in `app/goals/new.tsx` with validation and smart defaults.
- [ ] Wire created goals into UI navigation flow and confirm create/save path against Supabase.

### Blockers/Warnings
- No blockers in this iteration.
- Existing workspace has unrelated modifications in `prd-workouts.json`; left untouched.

### Files Changed
- lib/goals.ts
- lib/goals.test.js
- supabase/migrations/20260209_goals.sql
- lib/homeSummary.test.js
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- Date tests for local-time logic should avoid `Z` timestamps to prevent timezone-dependent failures.
---
---
## [2026-02-11 01:04] - Story GL-002: Goal creation wizard

### Completed
- Created `app/goals/_layout.tsx` with Stack navigator + theme styling
- Created `app/goals/new.tsx` ‚Äî full 4-step wizard (580 lines):
  - Step 1: Select from 6 goal types (pain reduction, symmetry, posture score, consistency, streak, custom) ‚Äî each with icon, color, description, example
  - Step 2: Set starting/target values with +/- adjusters, direction-aware validation (lower-is-better for pain, higher-is-better for scores)
  - Step 3: Deadline picker with 4 presets (4/8/12/26 weeks), showing computed dates
  - Step 4: Review card with summary stats, projected pace per week, and milestone timeline (25/50/75/100%)
- Saves to Supabase via existing `createGoal()` from `lib/goals.ts`
- Full theme integration (colors, typography, radii from lib/theme)
- Step indicator with progress dots and connecting lines
- Bottom navigation bar with Back/Next/Create Goal actions
- Validation prevents impossible goals (target must be achievable relative to start)
- TypeScript clean ‚Äî `npx tsc --noEmit` passes

### Next Up (for next iteration)
- [ ] Start GL-003: Goals dashboard and list view (app/(tabs)/goals.tsx)
- [ ] Add goals tab to main navigation in _layout.tsx
- [ ] Wire "Add Goal" button from goals list to /goals/new

### Blockers/Warnings
- None. Clean build.

### Files Changed
- app/goals/_layout.tsx (new)
- app/goals/new.tsx (new)
- prd.json (GL-002 marked as passes: true)
- progress.txt

---
## [2026-02-11 05:00] - Stories GL-003, GL-004, GL-005: Goals dashboard, detail screen, auto-tracking

### Completed
- GL-003: Goals dashboard (`app/(tabs)/goals.tsx`) ‚Äî new tab with summary stats, goal cards, progress bars, FAB, empty state, collapsible past goals
- GL-004: Goal detail screen (`app/goals/[id].tsx`) ‚Äî progress ring, stats, milestones, projection, history, actions (complete/pause/delete)
- GL-005: Automatic progress tracking (`lib/goalTracker.ts`) ‚Äî metric‚Üígoal mapping, auto-update on metric save, workout consistency/streak recalc, batch refresh, auto-completion
- Tab layout updated: Goals replaces Plan in visible tabs, Plan moved to hidden tabs
- 12 new tests all passing, TypeScript clean

### Next Up (for next iteration)
- [ ] Start GL-006: Goal celebrations and notifications (confetti, milestone toasts, badges)
- [ ] Start GL-007: Goal suggestions based on data (AI-powered recommendations)
- [ ] Wire goalTracker into metric entry screens (call trackMetricUpdate when saving metrics)
- [ ] Wire goalTracker into workout completion flow (call trackWorkoutCompleted)

### Blockers/Warnings
- None. Clean build.

### Files Changed
- app/(tabs)/_layout.tsx (Goals tab added, Plan moved to hidden)
- app/(tabs)/goals.tsx (new - Goals dashboard)
- app/goals/[id].tsx (new - Goal detail screen)
- lib/goalTracker.ts (new - Automatic progress tracking)
- lib/goalTracker.test.js (new - 12 tests)
- prd.json (GL-003, GL-004, GL-005 marked passes)

### Learnings
- When narrowing type with conditional (goal.status === 'active'), TypeScript won't allow checking for other status values inside. Use wider union guard.
- Goal detail needs getGoals() then filter since there's no single-goal fetch endpoint.

---
## [2026-02-12 01:15] - Story GL-006: Goal celebrations, milestones, and badge system

### Completed
- GoalCelebration.tsx (285 lines): Full-screen celebration modal with trophy animation, congrats message with stats (started at X, now at Y, took Z days), share button (clipboard), dismiss
- MilestoneToast.tsx (122 lines): Animated slide-in toast for 25/50/75% milestones, auto-dismiss after 3s
- lib/celebrations.ts (108 lines): Milestone detection (checkMilestones), celebration type determination (shouldCelebrate), integration points with goalTracker
- lib/badges.ts (175 lines): 7 badge types (first_goal, pain_crusher, consistency_king, streak_master, posture_pro, five_goals, perfect_week), CRUD functions, checkAndAwardBadges logic
- supabase/migrations/20260210_badges.sql: badges table with user_id, type, title, description, icon, earned_at
- Updated app/(tabs)/goals.tsx with badge count display
- Updated app/goals/[id].tsx with badges section
- Added expo-clipboard dependency for share functionality
- TypeScript clean (no new errors)

### Next Up (for next iteration)
- [ ] Start GL-007: Goal suggestions based on data (AI-powered recommendations)
- [ ] Wire celebrations into goalTracker (trigger toasts/modals on metric updates)
- [ ] Wire badges into workout completion flow
- [ ] Add badge display to profile screen
- [ ] Add confetti animation library (react-native-confetti-cannon) for richer celebrations

### Blockers/Warnings
- None. Clean build.

### Files Changed
- components/GoalCelebration.tsx (new)
- components/MilestoneToast.tsx (new)
- lib/badges.ts (new)
- lib/celebrations.ts (new)
- supabase/migrations/20260210_badges.sql (new)
- app/(tabs)/goals.tsx (modified - badge count)
- app/goals/[id].tsx (modified - badges section)
- package.json (modified - expo-clipboard)
- prd.json (GL-006 marked passes)
