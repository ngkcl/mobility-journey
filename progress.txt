## Codebase Patterns
- When adding new Expo Router routes, update `.expo/types/router.d.ts` so `router.push` stays type-safe.
- Keep Expo/React Native runtime-only modules (e.g. notifications) isolated from testable logic to avoid Node test loader issues.
- For streak calculations that check "active" status, use relative dates (today/yesterday) in tests.
- CSV export: escape commas/quotes properly, use native share sheet on mobile.
- For date logic that uses local time (`getHours`, `getDate`), write tests with local timestamps (no `Z`) to avoid timezone-dependent failures.
- Tests MUST use `node:test` + `node:assert/strict` (NOT Jest). For `.ts` files, use `module: 'Node16'` + `moduleResolution: 'Node16'` in TS_NODE_COMPILER_OPTIONS (NOT `commonjs`).
- Pure logic lives in `lib/*.ts`, UI in `app/`. Keep Supabase-dependent code separate from pure testable functions.
- For celebration/completion screens, reuse GoalCelebration.tsx pattern: Modal + Animated.spring + confetti particles.

---
## 2026-02-16 16:00 - Story TP-006: Program completion and next program

### Completed
1. **lib/programCompletion.ts** (240 lines): Pure completion logic data layer
   - `MetricSnapshot`, `ProgramOutcome`, `NextProgramSuggestion` types
   - `countTotalSessions()` / `countCompletedSessions()` ‚Äî session counting across nested phases
   - `computeProgramAdherence()` ‚Äî overall adherence percentage
   - `computeMetricChange()` ‚Äî direction-aware metric comparison (pain=lower-is-better, posture/symmetry=higher-is-better)
   - `didPrimaryMetricImprove()` ‚Äî checks the goal-specific primary metric
   - `buildOutcomeSummary()` ‚Äî human-readable outcome text
   - `buildProgramOutcome()` ‚Äî assembles complete outcome from program + metric snapshots
   - `suggestNextProgram()` ‚Äî intelligent next program suggestion based on outcomes:
     - Low adherence or no improvement ‚Üí same goal, adjusted approach
     - Pain reduced to ‚â§3 ‚Üí progress to posture improvement
     - Posture ‚â•75 ‚Üí progress to scoliosis correction
     - Symmetry ‚â•85 ‚Üí transition to general mobility maintenance
   - `formatMetricValue()` / `getMetricInfo()` ‚Äî display helpers

2. **lib/programCompletion.test.js** (31 tests all passing)
   - Full coverage of all pure functions
   - Session counting, adherence, metric changes, outcome building, next program suggestions, formatting

3. **app/training/completion.tsx** (500+ lines): Program completion celebration screen
   - Confetti animation (24 particles with staggered timing)
   - Animated entrance (spring scale + opacity fade)
   - Celebration header: trophy, program name, goal badge
   - Stats grid: days, weeks, adherence %, sessions completed
   - Before/After metrics comparison cards with improvement/worsening badges
   - Outcome assessment badge (primary metric improved or needs work)
   - Next program suggestion card with goal type, reason, focus shift, "Generate Next Program" CTA
   - Share button (native share sheet / clipboard fallback)
   - Parses starting metrics from program description (embedded by generator)

4. **app/training/_layout.tsx** ‚Äî registered completion screen in Stack navigator

5. **app/(tabs)/training.tsx** ‚Äî enhanced with program history
   - Fetches completed/paused programs from Supabase for history display
   - Program History section below empty state (when no active program)
   - ProgramHistoryCard component: status dot, name, goal type, duration, completion date, status badge
   - Tapping completed programs navigates to completion screen for review
   - Tapping paused programs also shows completion screen (can resume)

6. **.expo/types/router.d.ts** ‚Äî added `/training/completion` route (was already present)

### TRAINING PROGRAM PRD COMPLETE!
All 6 stories (TP-001 through TP-006) shipped.
- TP-001: Training program data model
- TP-002: AI program generator
- TP-003: Program overview screen
- TP-004: Session execution screen
- TP-005: Weekly review and progression
- TP-006: Program completion and next program ‚Üê THIS SESSION

### Next Up (post-PRD)
- [ ] Wire completion screen into advanceWeek() flow ‚Äî auto-navigate when program status becomes 'completed'
- [ ] Fetch real current metrics from Supabase instead of deriving from description
- [ ] Add program history section to profile screen (in addition to training tab)
- [ ] Consider adding a program_outcomes table for persisting completion results
- [ ] Add confetti cannon library (react-native-confetti-cannon) for richer animations

### Blockers/Warnings
- The completion screen currently derives "metricsAfter" as a placeholder improvement from "metricsBefore". In production, it should fetch actual current metrics from the `metric_entries` table.
- `parseMetricsFromDescription()` relies on the generator embedding "Starting pain level: X/10" in descriptions ‚Äî this works for programs created by `generateProgram()` but not manually created ones.
- Program history fetches from Supabase which requires live DB connection.

### Files Changed
- lib/programCompletion.ts (NEW ‚Äî completion logic)
- lib/programCompletion.test.js (NEW ‚Äî 31 tests)
- app/training/completion.tsx (NEW ‚Äî celebration screen)
- app/training/_layout.tsx (MODIFIED ‚Äî added completion screen to stack)
- app/(tabs)/training.tsx (MODIFIED ‚Äî program history, completed programs query)
- prd-training-program.json (MODIFIED ‚Äî TP-006 passes: true)
- .expo/types/router.d.ts (already had /training/completion route)

### Learnings (add to Codebase Patterns if reusable)
- For TypeScript test files, use `module: 'Node16'` + `moduleResolution: 'Node16'` in TS_NODE_COMPILER_OPTIONS ‚Äî NOT `module: 'commonjs'` which fails with `Option 'bundler' can only be used...` error.
- Celebration/completion screens follow GoalCelebration.tsx pattern: `Animated.spring()` for card entrance, staggered `Animated.timing()` for confetti.

---
## 2026-02-16 15:00 - Story TP-005: Weekly review and progression

### Completed
1. **Fixed 6 pre-existing broken test files** ‚Äî converted from Jest API (`@jest/globals`, `jest.fn()`, `jest.mock()`) to Node test runner (`node:test` + `node:assert/strict`). Added `ts-node/register/transpile-only` for TypeScript module loading.
   - `goalSuggestions.test.js` ‚Äî removed Jest mocks, tests pure `suggestionToGoalInput` + exports
   - `goalTracker.test.js` ‚Äî tests `isGoalComplete`/`computeGoalProgress` + module exports
   - `profileStats.test.js` ‚Äî simple API swap (describe/it/expect ‚Üí describe/it/assert)
   - `programGenerator.test.js` ‚Äî added ts-node register, full test suite for all exported functions
   - `sessionExecution.test.js` ‚Äî added ts-node register, full test suite for all helper functions
   - `trainingProgram.test.js` ‚Äî converted to Node test runner, shape validation tests
2. **Created `lib/weeklyReview.ts`** ‚Äî weekly review data layer with:
   - `WeekReview` type: adherence_pct, total_volume, pain_trend, sessions_completed/missed, energy
   - `computeWeekReview()` ‚Äî pure function computing review from week/phase/workout/pain data
   - `compareWeeks()` ‚Äî diff current vs previous week (adherence change, volume %, pain change)
   - `suggestAdjustments()` ‚Äî rule-based suggestions:
     - <40% adherence ‚Üí repeat_week
     - 40-60% adherence ‚Üí reduce_intensity (-10%)
     - Pain worsened ‚Üí reduce_intensity (-15% to -20% depending on severity)
     - Pain improved + high adherence ‚Üí advance
     - Stable + decent adherence ‚Üí continue
     - Good deload week ‚Üí increase_intensity (+5%)
   - `isWeekReadyForReview()` / `getWeekNeedingReview()` ‚Äî detect when review is needed
   - `reviewWeek()` ‚Äî async orchestrator fetching workout data + pain data from Supabase
   - `applyAdjustment()` ‚Äî modifies next week's intensity_pct
   - `submitReviewDecision()` ‚Äî applies adjustment + advances program (or repeats week)
3. **Created `lib/weeklyReview.test.js`** ‚Äî 25 tests covering all pure functions
4. **Created `app/training/weekly-review.tsx`** ‚Äî review modal screen with:
   - Stats grid (adherence, sessions, volume, intensity) with week-over-week changes
   - Pain trend badge with before/after averages
   - Selectable adjustment cards with visual indicators
   - Bottom action bar: Skip Review / Apply & Continue
5. **Updated `app/(tabs)/training.tsx`** ‚Äî added weekly review detection banner:
   - On load, checks `getWeekNeedingReview(program)` for just-completed weeks
   - Shows teal banner "Week N Review Ready" with link to review screen

### Next Up (for next iteration)
- [ ] TP-006: Program completion and next program
  - Completion celebration screen
  - Before/after metrics comparison
  - Next program generation
  - Program history on profile

### Blockers/Warnings
- The weekly review currently checks if ALL sessions are complete to trigger review ‚Äî partial week review (when calendar week passes) relies on `programStartDate` calculation
- `submitReviewDecision` doesn't persist the decision to a review_decisions table ‚Äî it applies changes directly. A future iteration could add a `program_review_decisions` table for audit trail
- Weekly review screen fetches data from Supabase via `reviewWeek()` ‚Äî requires live DB connection

### Files Changed
- lib/weeklyReview.ts (NEW)
- lib/weeklyReview.test.js (NEW)
- app/training/weekly-review.tsx (NEW)
- app/(tabs)/training.tsx (MODIFIED ‚Äî added review banner)
- lib/goalSuggestions.test.js (REWRITTEN ‚Äî Jest ‚Üí Node test runner)
- lib/goalTracker.test.js (REWRITTEN ‚Äî Jest ‚Üí Node test runner)
- lib/profileStats.test.js (REWRITTEN ‚Äî Jest ‚Üí Node test runner)
- lib/programGenerator.test.js (REWRITTEN ‚Äî Jest ‚Üí Node test runner)
- lib/sessionExecution.test.js (REWRITTEN ‚Äî Jest ‚Üí Node test runner)
- lib/trainingProgram.test.js (REWRITTEN ‚Äî Jest ‚Üí Node test runner)
- prd-training-program.json (MODIFIED ‚Äî TP-005 passes: true)

### Learnings (add to Codebase Patterns if reusable)
- Tests MUST use `node:test` + `node:assert/strict` ‚Äî NOT Jest. Previous iterations incorrectly used `@jest/globals` which doesn't exist in this project.
- For TypeScript modules in tests, always add `process.env.TS_NODE_COMPILER_OPTIONS` + `require('ts-node/register/transpile-only')` at the top before any `require('./module')`.

---
## 2025-02-10 - Overnight Feature Sprint: Streak Tracking + Data Export

### Completed
1. **Workout Streak Tracking with Calendar Heat Map**
   - Added `computeStreakStats()` to calculate current streak, best streak, and total workout days
   - Added `buildCalendarHeatMap()` for visual activity tracking (last 2 months)
   - Added `getStreakMessage()` for motivational messages based on streak status
   - Created `StreakCard` component with:
     - Current/Best/Total workout day statistics
     - Month-by-month calendar heat map (green = workout, gray = missed)
     - Motivational emoji + messages (üî• On Fire, üèÜ Legendary, etc.)
     - CTA button to start workout when streak is broken
   - Integrated StreakCard into Charts screen
   - Updated consistency chart to show best streak instead of current

2. **Export Workout Data**
   - Created `lib/exportData.ts` with:
     - `buildWorkoutCSV()` - generates CSV with all workout details
     - `computeWorkoutSummary()` - calculates totals and statistics
     - `buildWorkoutExportPayload()` - structured JSON export
   - Added export UI in workouts.tsx:
     - Export button in workout history header
     - CSV/JSON format toggle selector
     - Native share sheet on mobile, download on web
   - CSV includes: dates, exercises, sets, reps, weight, pain levels, volume, asymmetry

### Files Changed
- lib/workoutAnalytics.ts (streak stats, heat map, messages)
- lib/workoutAnalytics.test.js (relative date tests)
- lib/exportData.ts (new - CSV/JSON export)
- lib/exportData.test.js (new - export tests)
- components/StreakCard.tsx (new - streak visualization)
- app/(tabs)/charts.tsx (integrated StreakCard)
- app/(tabs)/workouts.tsx (export functionality)

### Learnings
- Streak "active" status should check if most recent workout is today or yesterday
- Test streak calculations with relative dates, not hardcoded future dates

---
## 2026-02-07 13:07 - Story WK-001: Exercise library with scoliosis-specific exercises

### Completed
- Added `exercises` Supabase table migration with seeded corrective + gym exercises.
- Built Exercise Library tab with search, category/target filters, and custom exercise creation.
- Added exercise detail screen showing targets, defaults, and side-specific emphasis.
- Added normalization utility + tests and updated route type definitions.

### Next Up (for next iteration)
- [ ] Start WK-002: workout logging tables + UI flow for workouts and sets.
- [ ] Confirm Supabase schema updates for workouts and workout_exercises.

### Blockers/Warnings
- `git push origin ralph/workout-tracker` failed: no `origin` remote configured.

### Files Changed
- supabase/migrations/20260207_exercises.sql
- lib/types.ts
- lib/exercises.ts
- lib/exercises.test.js
- app/(tabs)/exercises.tsx
- app/exercise/[id].tsx
- app/(tabs)/_layout.tsx
- .expo/types/router.d.ts
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- Added route typing update for new screens to keep `router.push` typecheck happy.
---
---
## 2026-02-07 13:14 - Story WK-002: Workout logging with sets, reps, weight

### Completed
- Added workouts/workout_exercises Supabase migration and new workout types.
- Built Workouts tab with start flow, exercise picker, per-set logging (side-specific), rest timer, and completion summary.
- Added workout summary utilities and tests for volume/left-right splits.

### Next Up (for next iteration)
- [ ] Start WK-003: corrective protocol templates and guided workout flow.
- [ ] Decide if workout history should include detail drill-down view.

### Blockers/Warnings
- `git push origin ralph/workout-tracker` failed: no `origin` remote configured.

### Files Changed
- supabase/migrations/20260207_workouts.sql
- lib/types.ts
- lib/workouts.ts
- lib/workouts.test.js
- app/(tabs)/workouts.tsx
- app/(tabs)/_layout.tsx
- .expo/types/router.d.ts
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- None.
---
---
## 2026-02-07 13:23 - Story WK-003: Corrective protocol templates (morning/midday/evening)

### Completed
- Added workout_templates Supabase migration with seeded morning/midday/evening corrective templates.
- Added guided protocol flow with timers, set tracking, and auto-advance, plus template customization UI.
- Added template helpers + tests for template set defaults.

### Next Up (for next iteration)
- [ ] Start WK-004: AI daily plan generator screen + API integration.
- [ ] Decide on workout history drill-down design for WK-005.

### Blockers/Warnings
- `git push origin ralph/workout-tracker` failed: no `origin` remote configured.

### Files Changed
- supabase/migrations/20260207_workout_templates.sql
- lib/types.ts
- lib/templates.ts
- lib/templates.test.js
- app/(tabs)/workouts.tsx
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- None.
---
---
## 2026-02-07 13:31 - Story WK-004: AI daily plan generator

### Completed
- Added daily plan Supabase table for generated plans with status tracking.
- Built Daily Plan tab with AI generation flow, plan editing, accept/regenerate actions, and plan history.
- Added daily plan normalization helpers and tests plus API client call.

### Next Up (for next iteration)
- [ ] Start WK-005: workout history list + analytics views.
- [ ] Confirm the daily plan API endpoint format matches the server implementation.

### Blockers/Warnings
- `git push origin ralph/workout-tracker` failed: no `origin` remote configured.

### Files Changed
- supabase/migrations/20260207_daily_plans.sql
- lib/api.ts
- lib/dailyPlan.ts
- lib/dailyPlan.test.js
- lib/types.ts
- app/(tabs)/plan.tsx
- app/(tabs)/_layout.tsx
- .expo/types/router.d.ts
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- None.
---
---
## 2026-02-07 13:38 - Story WK-005: Workout history and progress analytics

### Completed
- Extended workouts screen with history filters (date range, type, search) and expandable detail cards.
- Added workout analytics utilities and tests for consistency, streaks, volume, and side balance.
- Integrated workout analytics into Progress Charts with volume trends, strength progression, and left/right comparisons.

### Next Up (for next iteration)
- [ ] Start WK-006: workout reminders and scheduling.
- [ ] Confirm notification permissions flow for expo-notifications on iOS/Android.

### Blockers/Warnings
- None.

### Files Changed
- app/(tabs)/workouts.tsx
- app/(tabs)/charts.tsx
- lib/workoutAnalytics.ts
- lib/workoutAnalytics.test.js
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- None.
---
---
## 2026-02-07 14:09 - Story WK-006: Workout reminders and scheduling

### Completed
- Added workout schedule screen with session times, day toggles, and calendar preview.
- Implemented AsyncStorage-backed schedule normalization utilities and tests.
- Wired expo-notifications scheduling for corrective reminders/check-ins and added schedule access from Workouts.

### Next Up (for next iteration)
- [ ] Verify notification permissions + reminders on device (iOS/Android) and adjust channel config if needed.
- [ ] Decide if gym day reminders need a configurable time.

### Blockers/Warnings
- `git push origin ralph/workout-tracker` failed previously: no `origin` remote configured.

### Files Changed
- app/_layout.tsx
- app/(tabs)/workouts.tsx
- app/workout-schedule.tsx
- lib/workoutSchedule.ts
- lib/workoutSchedule.test.js
- lib/workoutNotifications.ts
- package.json
- pnpm-lock.yaml
- .expo/types/router.d.ts
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- None.
---

---
## 2025-02-09 - UX & Analytics Improvements

### Completed
1. **Fixed desktop TypeScript errors**
   - Added proper type declarations for @mediapipe/pose and @mediapipe/camera_utils
   - Added electron type reference for module resolution
   - Fixed posture-monitor.ts timer type (NodeJS.Timeout ‚Üí ReturnType<typeof setInterval>)
   - Updated tsconfig.json with custom typeRoots

2. **Enhanced workout analytics** (lib/workoutAnalytics.ts)
   - `buildOverallAsymmetryTrend`: Track L/R volume imbalance across ALL exercises
   - `computeAsymmetrySummary`: Trend direction (improving/worsening/stable), dominant side
   - `buildWorkoutPainTrend`: Pain/energy levels before and after workouts
   - `computePainImpact`: Average pain change after workouts

3. **Added EmptyState component** (components/EmptyState.tsx)
   - Reusable empty state with icon, title, description, and action button
   - Consistent styling with design system

4. **Charts page enhancement** (app/(tabs)/charts.tsx)
   - Added "Balance Status" card showing current asymmetry %, dominant side, trend direction
   - Added "Pain Impact" card showing average pain change from workouts
   - Color-coded indicators for improvement/concern status

### Next Up
- [ ] Add EmptyState to more screens (exercises, workouts, metrics)
- [ ] Improve loading skeletons for better perceived performance
- [ ] Consider adding accessibility labels for screen readers
- [ ] Implement AirPods integration (needs dev build)

### Files Changed
- desktop/src/types/mediapipe.d.ts (new)
- desktop/src/types/electron.d.ts (new)
- desktop/tsconfig.json
- desktop/src/renderer/lib/posture-monitor.ts
- lib/workoutAnalytics.ts
- components/EmptyState.tsx (new)
- app/(tabs)/charts.tsx
- progress.txt

### Learnings
- Browser setInterval returns number, not NodeJS.Timeout. Use ReturnType<typeof setInterval> for cross-platform compatibility.
- For packages without @types, create src/types/package.d.ts and add typeRoots to tsconfig.

---
## 2026-02-08 - Desktop Posture App: Stats & Calibration Fixes

### Problem Diagnosed
Nick reported that after calibrating the posture monitor, stats stay at 0 and nothing happens.

**Root cause analysis:**
1. The app structure has TWO architectures:
   - Root-level JS files (main.js, preload.js, renderer.js) - ACTIVE, using MediaPipe via CDN
   - TypeScript in src/ - partially complete, src/main/ is EMPTY
   
2. Camera permission issues on macOS - the app wasn't properly requesting camera access.

3. Race condition in calibration - the calibration handler could be called multiple times if detectLoop continued running during calibration.

4. On systems without a camera (like Mac Mini), the app fails silently.

### Fixes Applied
1. **Camera permission handling** (main.js)
   - Added systemPreferences.askForMediaAccess('camera') on app ready
   - Shows notification if permission denied with instructions

2. **Better error messages** (renderer.js)
   - Camera errors now show specific messages (NotAllowedError, NotFoundError)
   - Added logging throughout for debugging

3. **Calibration race condition fix** (renderer.js)
   - Added `calibrationProcessed` flag to prevent double-processing
   - Skip detectLoop frames during calibration (isCalibrating check)
   - Restore normal handler BEFORE processing to prevent race

4. **Console logging from renderer** (main.js)
   - Added webContents.on('console-message') to forward renderer logs to main

5. **Stats API in preload** (preload.js)
   - Added getStats() and resetStats() to electronAPI for UI stats fetching

### Testing Notes
- Mac Mini has no camera, so app fails with "NotFoundError Requested device not found"
- On a device with camera (like Nick's laptop), the flow should work:
  1. App requests camera permission
  2. Camera initializes, MediaPipe loads
  3. Calibrate captures baseline
  4. detectLoop sends frames every 1.5s
  5. Stats accumulate in ~/.posture-data/stats.json

### Files Changed
- desktop/main.js (camera permission, logging)
- desktop/renderer.js (calibration fix, logging, error handling)
- desktop/preload.js (stats API)

### Next Steps
- [ ] Test on Nick's laptop with camera to verify full flow
- [ ] Consider adding a "mock camera" mode for development on devices without camera
- [ ] Add visual feedback when calibration countdown is happening

## Feb 9, 2026 ‚Äî Evening Session (Jared)

### Weekly Reports Feature Committed! üéâ

Found and committed ~2400 lines of uncommitted work on weekly reports system:

**What was shipped:**
- `lib/weeklyReport.ts` ‚Äî Core report generation with workout summaries, metric aggregation, photo tracking
- `lib/reportInsights.ts` ‚Äî Smart insight engine (achievements, warnings, tips) that generates actionable feedback
- `lib/weeklyReportStorage.ts` ‚Äî Supabase persistence layer with auto-generation logic
- `app/(tabs)/reports.tsx` ‚Äî Full 734-line Reports tab with beautiful card UI
- Tests for both report generation and insights (19 tests, all passing)
- Supabase migration for `weekly_reports` table

**Navigation change:**
- Reports tab now in main nav (replaced Charts)
- Charts still accessible via router.push() ‚Äî moved to hidden tabs

**Key features:**
- Insight engine surfaces max 5 most important observations per week
- Trends comparison (current week vs previous)
- Photo side-by-side comparison when available
- Share button with formatted text export
- Auto-generates last week's report on Monday app open

All 6 weekly report user stories (WR-001 through WR-006) now complete.
---
## [2026-02-09 05:14] - Story GL-001: Goal data model and storage

### Completed
- Added `lib/goals.ts` with goal domain types (`Goal`, `GoalType`, `GoalStatus`, `GoalProgress`) and progress-summary typing.
- Implemented goals data access helpers: `createGoal`, `updateGoal`, `deleteGoal`, `getGoals`, `getGoalProgress`.
- Implemented `computeGoalProgress(goal)` with direction-aware progress logic (pain goals decrease, score/consistency/streak goals increase), on-track calculation, projected completion, and trend detection.
- Added `lib/goals.test.js` with coverage for improvement goals, pain reduction, completion, regression, overdue goals, and projection behavior.
- Added Supabase migration `20260209_goals.sql` creating `goals` and `goal_progress` tables with constraints and indexes.
- Fixed pre-existing baseline test instability in `lib/homeSummary.test.js` (timezone-sensitive assertions and rotation expectation) so test suite is reliable.

### Next Up (for next iteration)
- [ ] Start GL-002: implement the goal creation wizard in `app/goals/new.tsx` with validation and smart defaults.
- [ ] Wire created goals into UI navigation flow and confirm create/save path against Supabase.

### Blockers/Warnings
- No blockers in this iteration.
- Existing workspace has unrelated modifications in `prd-workouts.json`; left untouched.

### Files Changed
- lib/goals.ts
- lib/goals.test.js
- supabase/migrations/20260209_goals.sql
- lib/homeSummary.test.js
- prd.json
- progress.txt

### Learnings (add to Codebase Patterns if reusable)
- Date tests for local-time logic should avoid `Z` timestamps to prevent timezone-dependent failures.
---
---
## [2026-02-11 01:04] - Story GL-002: Goal creation wizard

### Completed
- Created `app/goals/_layout.tsx` with Stack navigator + theme styling
- Created `app/goals/new.tsx` ‚Äî full 4-step wizard (580 lines):
  - Step 1: Select from 6 goal types (pain reduction, symmetry, posture score, consistency, streak, custom) ‚Äî each with icon, color, description, example
  - Step 2: Set starting/target values with +/- adjusters, direction-aware validation (lower-is-better for pain, higher-is-better for scores)
  - Step 3: Deadline picker with 4 presets (4/8/12/26 weeks), showing computed dates
  - Step 4: Review card with summary stats, projected pace per week, and milestone timeline (25/50/75/100%)
- Saves to Supabase via existing `createGoal()` from `lib/goals.ts`
- Full theme integration (colors, typography, radii from lib/theme)
- Step indicator with progress dots and connecting lines
- Bottom navigation bar with Back/Next/Create Goal actions
- Validation prevents impossible goals (target must be achievable relative to start)
- TypeScript clean ‚Äî `npx tsc --noEmit` passes

### Next Up (for next iteration)
- [ ] Start GL-003: Goals dashboard and list view (app/(tabs)/goals.tsx)
- [ ] Add goals tab to main navigation in _layout.tsx
- [ ] Wire "Add Goal" button from goals list to /goals/new

### Blockers/Warnings
- None. Clean build.

### Files Changed
- app/goals/_layout.tsx (new)
- app/goals/new.tsx (new)
- prd.json (GL-002 marked as passes: true)
- progress.txt

---
## [2026-02-11 05:00] - Stories GL-003, GL-004, GL-005: Goals dashboard, detail screen, auto-tracking

### Completed
- GL-003: Goals dashboard (`app/(tabs)/goals.tsx`) ‚Äî new tab with summary stats, goal cards, progress bars, FAB, empty state, collapsible past goals
- GL-004: Goal detail screen (`app/goals/[id].tsx`) ‚Äî progress ring, stats, milestones, projection, history, actions (complete/pause/delete)
- GL-005: Automatic progress tracking (`lib/goalTracker.ts`) ‚Äî metric‚Üígoal mapping, auto-update on metric save, workout consistency/streak recalc, batch refresh, auto-completion
- Tab layout updated: Goals replaces Plan in visible tabs, Plan moved to hidden tabs
- 12 new tests all passing, TypeScript clean

### Next Up (for next iteration)
- [ ] Start GL-006: Goal celebrations and notifications (confetti, milestone toasts, badges)
- [ ] Start GL-007: Goal suggestions based on data (AI-powered recommendations)
- [ ] Wire goalTracker into metric entry screens (call trackMetricUpdate when saving metrics)
- [ ] Wire goalTracker into workout completion flow (call trackWorkoutCompleted)

### Blockers/Warnings
- None. Clean build.

### Files Changed
- app/(tabs)/_layout.tsx (Goals tab added, Plan moved to hidden)
- app/(tabs)/goals.tsx (new - Goals dashboard)
- app/goals/[id].tsx (new - Goal detail screen)
- lib/goalTracker.ts (new - Automatic progress tracking)
- lib/goalTracker.test.js (new - 12 tests)
- prd.json (GL-003, GL-004, GL-005 marked passes)

### Learnings
- When narrowing type with conditional (goal.status === 'active'), TypeScript won't allow checking for other status values inside. Use wider union guard.
- Goal detail needs getGoals() then filter since there's no single-goal fetch endpoint.

---
## [2026-02-12 01:15] - Story GL-006: Goal celebrations, milestones, and badge system

### Completed
- GoalCelebration.tsx (285 lines): Full-screen celebration modal with trophy animation, congrats message with stats (started at X, now at Y, took Z days), share button (clipboard), dismiss
- MilestoneToast.tsx (122 lines): Animated slide-in toast for 25/50/75% milestones, auto-dismiss after 3s
- lib/celebrations.ts (108 lines): Milestone detection (checkMilestones), celebration type determination (shouldCelebrate), integration points with goalTracker
- lib/badges.ts (175 lines): 7 badge types (first_goal, pain_crusher, consistency_king, streak_master, posture_pro, five_goals, perfect_week), CRUD functions, checkAndAwardBadges logic
- supabase/migrations/20260210_badges.sql: badges table with user_id, type, title, description, icon, earned_at
- Updated app/(tabs)/goals.tsx with badge count display
- Updated app/goals/[id].tsx with badges section
- Added expo-clipboard dependency for share functionality
- TypeScript clean (no new errors)

### Next Up (for next iteration)
- [ ] Start GL-007: Goal suggestions based on data (AI-powered recommendations)
- [ ] Wire celebrations into goalTracker (trigger toasts/modals on metric updates)
- [ ] Wire badges into workout completion flow
- [ ] Add badge display to profile screen
- [ ] Add confetti animation library (react-native-confetti-cannon) for richer celebrations

### Blockers/Warnings
- None. Clean build.

### Files Changed
- components/GoalCelebration.tsx (new)
- components/MilestoneToast.tsx (new)
- lib/badges.ts (new)
- lib/celebrations.ts (new)
- supabase/migrations/20260210_badges.sql (new)
- app/(tabs)/goals.tsx (modified - badge count)
- app/goals/[id].tsx (modified - badges section)
- package.json (modified - expo-clipboard)
- prd.json (GL-006 marked passes)

---
## [2026-02-12 05:01] - Story GL-007: AI-powered goal suggestions based on user metrics

### Completed
- goalSuggestions.ts (478 lines): Full suggestion engine with metric analysis
  - Fetches latest + 7-day avg for pain, posture, symmetry
  - Computes 2-week trends (improving/stable/worsening)
  - 5 suggestion types: pain reduction, symmetry, posture, consistency, streak
  - Smart thresholds: pain>5, symmetry<80%, posture<70, consistency<70%, streak<3
  - Realistic targets: halve pain (min 2), improve by 50% of gap, etc.
  - Priority-sorted, max 3 suggestions, skips types with active goals
- SuggestedGoals.tsx (355 lines): "Suggested for you" dashboard component
  - Suggestion cards with icon, title, reason, target range, timeframe
  - One-tap "Start this goal" (creates goal instantly from suggestion)
  - "Customize" button navigates to pre-filled creation wizard
  - Dismiss button per suggestion
  - Loading state, auto-refresh on goal creation
- Updated app/(tabs)/goals.tsx with SuggestedGoals integration
- Updated app/goals/new.tsx with prefill support via URL params
- 8 new tests all passing, TypeScript clean

### üéâ GOAL TRACKING PRD COMPLETE!
All 7 stories (GL-001 through GL-007) shipped and merged to main.
- GL-001: Goal data model and storage
- GL-002: Goal creation wizard
- GL-003: Goals dashboard and list view
- GL-004: Goal detail screen with history
- GL-005: Automatic progress tracking
- GL-006: Goal celebrations and notifications
- GL-007: AI-powered goal suggestions ‚Üê THIS SESSION

### What's Next (post-PRD polish)
- [ ] Wire celebrations into goalTracker (trigger toasts/modals on metric updates)
- [ ] Wire badges into workout completion flow
- [ ] Add confetti animation library for richer celebrations
- [ ] Add badge display to profile screen
- [ ] Create new PRD: Workout plan AI generation or AirPods integration deep-dive

### Files Changed
- lib/goalSuggestions.ts (new)
- lib/goalSuggestions.test.js (new)
- components/SuggestedGoals.tsx (new)
- app/(tabs)/goals.tsx (modified - SuggestedGoals integration)
- app/goals/new.tsx (modified - prefill params support)
- prd.json (GL-007 marked passes)
- progress.txt

## Feb 13, 2026 ‚Äî Evening Session: Celebration Wiring

### What was done
**Wired celebration system into goal tracking pipeline (post-PRD polish #1)**

- Created `lib/CelebrationContext.tsx` (188 lines): React context + provider
  - `CelebrationProvider` wraps app root, renders MilestoneToast + GoalCelebration overlay
  - `useCelebration()` hook: checkAndCelebrate, showMilestoneToast, showCelebration
  - Celebration queue: processes multiple milestones sequentially (toast ‚Üí toast ‚Üí full modal)
  - Auto-awards badges via `checkAndAwardBadges` on goal completion
- Updated `lib/goalTracker.ts`: New `TrackResult` return type with `previousValues` map
  - `trackMetricUpdate()` and `trackWorkoutCompleted()` now return previous values
  - Enables milestone detection (was 20% ‚Üí now 26% = crossed 25% milestone)
- Updated `app/_layout.tsx`: Added CelebrationProvider to root layout
- Updated `app/(tabs)/metrics.tsx`: After saving a check-in, tracks pain/posture/symmetry goals and fires celebrations
- Updated `app/(tabs)/workouts.tsx`: After logging workout (manual + guided), tracks consistency/streak goals and fires celebrations
- TypeScript clean, all 5 files modified, 268 insertions

### What's next (remaining polish)
- [ ] Wire badges into profile screen display
- [ ] Add confetti animation library (expo-confetti-cannon?) for richer celebration
- [ ] Create new PRD: Workout plan AI generation or AirPods integration deep-dive

---
## [2026-02-13 05:30] - Comprehensive Profile Screen + Training Program PRD

### Completed
1. **Profile Stats Data Layer** (`lib/profileStats.ts`, 225 lines)
   - `loadProfileStats()` aggregates data from workouts, goals, badges, metrics, photos
   - Computes: days since start, total workouts/minutes/sets, streak stats, goal counts, badge counts, latest metrics, photo count
   - Milestone generator: auto-generates journey milestones (first workout, first goal, workout count milestones, first badge, first photo)
   - All data fetched in parallel for performance

2. **Comprehensive Profile Screen** (`app/(tabs)/profile.tsx`, 600+ lines)
   - Hero card: journey day count, start date, current/best streak with fire/trophy emoji
   - 4-tile stat grid: total workouts, active time, sets done, check-ins
   - Current Status section: pain/posture/symmetry metric pills with progress bars (pain is inverted ‚Äî lower = better)
   - Goals summary: active/completed/total with link to goals tab
   - **Badges grid**: shows all 7 badge types with earned/locked states, earned dates, full definitions
   - Journey Milestones: vertical timeline with icons, titles, descriptions, dates
   - Explore section: 6 quick links to Photos, Exercises, Health, Charts, Program, Metrics
   - Photo CTA card with total count
   - Pull-to-refresh, focus-effect reload

3. **Profile Stats Tests** (`lib/profileStats.test.js`, 10 tests passing)
   - formatMinutes helper (under/over hour, exact hours)
   - Milestone sorting, date computation, workout count triggering
   - Metric pill percentage (regular + inverted for pain)

4. **Training Program PRD** (`prd-training-program.json`)
   - 6 user stories (TP-001 through TP-006) for next feature cycle
   - Smart multi-week rehabilitation programs with 4-phase approach
   - Data model, AI generator, overview screen, session execution, weekly review, completion flow
   - Progressive overload, deload weeks, auto-adjustment based on pain/adherence
   - Designed for scoliosis rehabilitation: release ‚Üí activate ‚Üí strengthen ‚Üí integrate

### What's Next (immediate polish)
- [ ] Add confetti animation library for richer celebrations
- [ ] Start TP-001: Training program data model

### Files Changed
- lib/profileStats.ts (new ‚Äî stats aggregation)
- lib/profileStats.test.js (new ‚Äî 10 tests)
- app/(tabs)/profile.tsx (rewritten ‚Äî comprehensive profile)
- prd-training-program.json (new ‚Äî next feature cycle PRD)

## 2026-02-14 ‚Äî TP-001: Training Program Data Model (Evening Session)

### Completed
1. **Supabase Migration** (`supabase/migrations/20260214_training_programs.sql`)
   - 5 tables: training_programs, program_phases, program_weeks, program_sessions, program_exercise_slots
   - Full constraint validation: status, goal_type, phase focus, session type, exercise side, day of week, intensity %
   - Indexes on all foreign keys + status fields

2. **TypeScript Data Layer** (`lib/trainingProgram.ts`, 320 lines)
   - Complete type system: TrainingProgram, ProgramPhase, ProgramWeek, ProgramSession, ProgramExerciseSlot
   - Nested CRUD: createProgram inserts full tree (program ‚Üí phases ‚Üí weeks ‚Üí sessions ‚Üí exercise slots)
   - getProgramDetail fetches and assembles full tree from 5 tables
   - advanceWeek handles week progression and auto-completion
   - completeSession, getWeekSessions, deleteProgram (cascade)

3. **Unit Tests** (`lib/trainingProgram.test.js`, 9 tests passing)
   - Type shape validation for all entities
   - Deload week properties, phase focus types, session types
   - Full nested program structure assembly
   - Week number accumulation across phases

### What's Next
- [ ] TP-002: AI program generator (rule-based + optional API)
- [ ] TP-003: Program overview screen (tab replacement)

---
## [2026-02-14 05:30] - Story TP-002: AI Program Generator (Rule-Based)

### Completed
1. **programGenerator.ts** (475 lines): Full rule-based program generation engine
   - `generateProgram(userContext, config?)` ‚Üí complete CreateProgramInput ready for Supabase
   - `inferGoalType()` ‚Äî deduces goal from user metrics + active goals (pain ‚Üí scoliosis ‚Üí posture ‚Üí general)
   - `inferDuration()` ‚Äî 4-8 weeks based on experience level, pain severity, goal type
   - `inferSessionsPerWeek()` ‚Äî 3-6 based on workout history
   - `buildPhases()` ‚Äî 4-phase structure with goal-specific week distribution (sum always === totalWeeks)
   - `getExercisesForPhase()` ‚Äî filters exercise library by phase-appropriate categories
   - `selectExercisesForSession()` ‚Äî picks exercises with variety (avoids repeats, covers muscle groups)
   - `buildExerciseSlots()` ‚Äî phase-aware params (release=low sets/long holds, strengthen=high sets/weight)
   - `buildWeekSessions()` ‚Äî maps sessions to weekdays (Mon/Tue/Thu/Fri etc.)
   - `buildPhaseWeeks()` ‚Äî progressive intensity (+3%/week), deload week insertion
   - `summarizeProgram()` ‚Äî human-readable summary for review before saving

2. **programGenerator.test.js** (510 lines): 51 unit tests all passing
   - inferGoalType: 6 tests (explicit goals, metric inference, fallbacks)
   - inferDuration: 5 tests (beginners, pain, scoliosis, experienced, moderate)
   - inferSessionsPerWeek: 4 tests (new, building, moderate, experienced)
   - buildPhases: 5 tests (4 phases, sum validation, phase weights by goal)
   - getExercisesForPhase: 4 tests (release, activate, strengthen, integrate categories)
   - selectExercisesForSession: 4 tests (count, unused preference, muscle coverage, empty pool)
   - buildExerciseSlots: 5 tests (release params, strengthen weight, deload reduction, side, holds)
   - buildWeekSessions: 4 tests (count, days, exercises, incomplete status)
   - buildPhaseWeeks: 5 tests (count, sequential weeks, deload interval, intensity progression)
   - generateProgram: 7 tests (complete output, week totals, sessions, exercises, config, sequential weeks, pain inference)
   - summarizeProgram: 2 tests (summary accuracy, phase sum consistency)

### What's Next
- [ ] TP-003: Program overview screen (app/(tabs)/training.tsx)
- [ ] TP-004: Session execution screen

### Files Changed
- lib/programGenerator.ts (new ‚Äî 475 lines)
- lib/programGenerator.test.js (new ‚Äî 510 lines, 51 tests)
- prd-training-program.json (TP-002 marked passes)

---
## [2026-02-15 01:00] - Story TP-003: Program Overview Screen (Training Tab)

### Completed
1. **app/(tabs)/training.tsx** (853 lines): Full program overview screen
   - `EmptyState` ‚Äî CTA to generate program when none active
   - `ProgramHeader` ‚Äî name, description, goal type badge, week X/Y, start date
   - `PhaseTimeline` ‚Äî horizontal bar with color-coded segments (release=purple, activate=blue, strengthen=amber, integrate=green), current phase highlighted
   - `StatsRow` ‚Äî weeks completed, sessions done this week, adherence % with color coding
   - `WeekCard` ‚Äî per-week cards with phase badge, session dots (completed=green/empty=border), intensity %, deload badge, progress bar
   - Current week highlighted with teal accent border + "Current" badge
   - Floating "Start Today's Session" button (visible when today has an uncompleted session)
   - Pull to refresh, loading spinner, error state with retry
   
2. **Tab layout updated** ‚Äî training.tsx added to visible tabs (barbell icon), replaces plan in nav

### TypeScript
- Clean compile (0 errors)
- Fixed typography refs: label‚ÜícaptionMedium, bodySmall‚Üícaption (matching theme.ts)

### What's Next
- [ ] TP-004: Session execution screen
- [ ] TP-005: Weekly review and progression
- [ ] TP-006: Program completion and next program

### Files Changed
- app/(tabs)/training.tsx (new ‚Äî 853 lines)
- app/(tabs)/_layout.tsx (training added to visible tabs)
- prd-training-program.json (TP-003 marked passes)

---
## [2026-02-15 05:30] - Story TP-004: Session Execution Screen (Guided Workout)

### Completed
1. **app/training/_layout.tsx** (30 lines): Stack navigator for training sub-screens
2. **app/training/session.tsx** (930+ lines): Full guided session execution screen
   - Loading state with program/session data fetch
   - Exercise list with expandable cards showing slot details, target muscles, notes
   - Per-set tracking: reps/weight/duration/RPE inputs with tap-to-complete
   - Automatic rest timer overlay with countdown, progress bar, skip button, vibration on completion
   - Progress bar + badge row: phase badge, session type badge, deload badge, set counter
   - Post-session check-in screen: pain before/after, energy before/after, session notes
   - Full summary screen: programmed vs actual stats, duration, volume, L/R balance, completion %
   - Saves completed exercises to workout_exercises table (workout history integration)
   - Marks program_sessions as completed
   - Triggers goal tracker for workout consistency/streak goals
   - Clean back navigation and Finish button with ready state

3. **lib/sessionExecution.ts** (185 lines): Testable pure helpers
   - createSetsForSlot: converts ProgramExerciseSlot ‚Üí SetLog[]
   - calculateProgress: progress % from exercise logs
   - buildSessionSummary: programmed vs actual comparison
   - sessionTypeToWorkoutType: type mapping
   - findSession: nested program structure traversal
   - setLogToWorkoutSet: SetLog ‚Üí WorkoutSet for persistence

4. **lib/sessionExecution.test.js** (260 lines): 18 tests all passing
   - createSetsForSlot: 3 tests (reps, duration, side default)
   - calculateProgress: 3 tests (empty, partial, all done)
   - buildSessionSummary: 2 tests (partial completion, full completion)
   - sessionTypeToWorkoutType: 4 tests
   - findSession: 4 tests (by id, by day, no match, missing week)
   - setLogToWorkoutSet: 2 tests (filled, empty)

5. **Wiring**: Training overview FAB + week cards now navigate to session screen

### What's Next
- [ ] TP-005: Weekly review and progression
- [ ] TP-006: Program completion and next program

### Files Changed
- app/training/_layout.tsx (new)
- app/training/session.tsx (new)
- lib/sessionExecution.ts (new)
- lib/sessionExecution.test.js (new)
- app/(tabs)/training.tsx (wired FAB + week card navigation)
- prd-training-program.json (TP-004 marked passes)
- progress.txt

## Evening Session ‚Äî Feb 16, 2026

### Completed: Weekly Report PRD (WR-001 through WR-006) ‚Äî ALL PASSING ‚úÖ

**Discovery:** WR-001 through WR-004 were already fully implemented but PRD wasn't updated:
- WR-001: weeklyReport.ts (545 lines) ‚Äî types, data fetching, summary builders, generator
- WR-002: weeklyReportStorage.ts (227 lines) ‚Äî Supabase CRUD, upsert, cache check
- WR-003: app/(tabs)/reports.tsx (734 lines) ‚Äî full viewer with sections, trends, insights
- WR-004: reportInsights.ts (310 lines) + 13 passing tests

**WR-005 (Report Sharing):** Already implemented ‚Äî Share.share() native sheet, markReportShared()

**WR-006 (Auto-generation):** Implemented this session:
- shouldAutoGenerateReport() checks Mon/Tue if last week's report is missing
- Added auto-generation call on home screen mount (useEffect)
- "New report available" teal banner on home screen with tap-to-navigate
- Silent fail ‚Äî never blocks home screen

### PRD Status After Session
- prd.json (Goals): 7/7 ‚úÖ
- prd-workouts.json: 6/6 ‚úÖ
- prd-training-program.json: 6/6 ‚úÖ
- prd-weekly-report.json: 6/6 ‚úÖ (ALL completed this session)
- prd-airpods.json: 0/6 (requires dev build)

### What's Next
- prd-airpods.json stories (need expo-dev-client setup)
- Polish/UX improvements across existing features
- End-to-end testing with real Supabase data
